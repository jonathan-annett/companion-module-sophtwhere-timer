const[button,button2,button3]=[].slice.call(document.querySelectorAll("button")),h1=document.querySelector("h1");window.tab_id="tab_"+Date.now().toString();var controller_tab_id="controller_"+tab_id;const updateTabTick=hysteresisWrap(doUpdateTabTick,500);let tabidInterval;var timerWin,peer,loopbackId,runMode="controller";function startPeer(e){function t(){document.querySelector("input").hidden=!0,button.hidden=!0,button2.hidden=!0,h1.innerHTML="WebRTC Link is Closed",enablePaste()}(peer=new SimplePeer({initiator:!1,trickle:!1})).on("signal",function(e){encodeObjectData({signal:e,id:loopbackId},location.origin+"/webrtcSignal.html?",function(e,t){if(e)return alert(e);document.querySelector("input").value=t;const n=new Blob(["[InternetShortcut]\nURL="+t]);button.onclick=function(){saveAs(n,"link.url"),button.onclick=null,button.disabled=!0},button2.disabled=!1,button2.onclick=function(){var e=document.querySelector("input");e.select(),e.setSelectionRange(0,99999),navigator.clipboard.writeText(e.value),button2.disabled=!0},button.disabled=!1,button2.disabled=!1,button.hidden=!1,button2.hidden=!1,button3.disabled=!0,h1.innerHTML="Open this link in a new tab, on the OTHER computer. (keep this tab open)"})}),peer.on("connect",function(){document.querySelector("input").hidden=!0,button.hidden=!0,button2.hidden=!0,h1.innerHTML="Link established"}),peer.on("data",function(e){try{const n=JSON.parse(e);console.log({in:n}),n.storage?Object.keys(n.storage).forEach(function(e){var t=n.storage[e];localStorage.setItem(e,t),console.log(e,"---\x3e",t)}):n.ready&&enableOpenTimer()}catch(e){console.log(e)}}),peer.on("close",t),peer.on("error",t),peer.signal(e)}function enableOpenTimer(){button2.onclick=function(){openTimerWindow(!1),button2.disabled=!0,h1.innerHTML="Timer window opened - keep this tab open to maintain the WebRTC link",tabidInterval&&clearInterval(tabidInterval),tabidInterval=setInterval(updateTabId,500)},button2.innerHTML="open timer",button2.disabled=!1,button2.hidden=!1}function enablePaste(){button3.onclick=function(){button3.disabled=!0,navigator.clipboard.readText().then(function(e){var t=location.href.split("?")[0];decodeObjectData(e,t,function(e,t){if(e)return enablePaste();startPeer(t.signal)})}).catch(enablePaste)},button3.disabled=!1}function openTimerWindow(e){return!0===e?(timerWin&&timerWin.close(),window.opener&&window.close(),timerWin=void 0):(timerWin=open("timer.html?presenter&linked","remote_timer_window","location=0"))&&timerWin.addEventListener("load",function(){console.log("timer win loaded"),timerWin.addEventListener("unload",onTimerWinUnload)}),!1}function onTimerWinUnload(){enableOpenTimer()}function updateTabId(){getTabCount()}function doUpdateTabTick(e){writeNumber(tab_id,e),"controller"===runMode?writeNumber(controller_tab_id,e):localStorage.removeItem(controller_tab_id)}function hysteresisWrap(t,n){let o=null;return function(){var e=Date.now();o&&o+n>e||(o=e,t(e))}}function getTabCount(t){var n=[];let o=1,e=Date.now(),i=e-3e3;t||updateTabTick();for(let e=0;e<localStorage.length;e++){var r=localStorage.key(e);r!==tab_id&&r.startsWith("tab_")?Number(localStorage.getItem(r))<i?n.push(r):(!t||0<readNumber("controller_"+r,0))&&o++:r.startsWith("controller_tab_")&&Number(localStorage.getItem(r))<i&&n.push(r)}return n.forEach(function(e){localStorage.removeItem(e)}),o}function writeNumber(e,t){void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t.toString())}function readNumber(e,t){e=localStorage.getItem(e);return e?Number(e):t}window.name="timer_webrtc_remote",decodeObjectData(location.href,location.origin,function(e,t){if(e)return enablePaste();window.onstorage=null,loopbackId=t.id,localStorage.getItem("linked-peer-id")===loopbackId?h1.innerHTML="Link opened on same system - ignored":startPeer(t.signal)});