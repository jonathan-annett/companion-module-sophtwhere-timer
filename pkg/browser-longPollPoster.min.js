let server_conn;function sendTimerApiMessage(o){server_conn&&(window.thisBrowserId&&(o.browserId=window.thisBrowserId),server_conn.send(JSON.stringify(o)),delete o.browserId)}function openLongPollPoster(n,e,o){n=n||0;const i="/msg-poll";let t=!1,s=[];if("function"==typeof e&&s.push(e),o){var c=e;let o={on:a,send:function o(n,e,t){if(r)r.send(n),setTimeout(e,10,void 0,!t);else{if(t&&10<=t)return e?e(new Error("could not send")):location.replace(location.href);setTimeout(o,500,n,e,(t||0)+1)}},lastId:n},r;return function n(){r=new WebSocket(location.origin.replace("http://","ws://"));r.onopen=function(o){s.forEach(function(o){o({cmd:"opened"})})};r.onmessage=function(o){const n=o.data;try{const e=JSON.parse(n);s.forEach(function(o){o(e)})}catch(n){s.forEach(function(o){o({error:n})})}};r.onclose=function(o){o.wasClean,r&&(r.onerror=void 0,r.onclose=void 0,r.onmessage=void 0,r=void 0,setTimeout(n,1500))};r.onerror=function(o){c(o),r&&(r.onerror=void 0,r.onclose=void 0,r.onmessage=void 0,r=void 0,setTimeout(n,1500))}}(),o}{let r={on:a,send:function(o,n){function e(o){return o.error?n(new Error(o.error)):o.success?n?n():void 0:void location.replace(location.href)}function t(o){if(n)return n(o)}fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({send:o})}).then(function(o){o.json().then(e).catch(t)}).catch(t)},lastId:n};return function e(){if(!t)return setTimeout(function(){s.forEach(function(o){o({cmd:"opened"})}),t=!0,e()},100);f(function(o,n){n&&n.forEach(function(o){const n=JSON.parse(o.msg);s.forEach(function(o){o(n)})}),o&&(console.log("error in longpoll:",o),t=!1),e()})}(),r;function a(o,n){"message"===o&&"function"==typeof n&&s.push(n)}function f(n){function e(o){o.messages?(r.lastId=o.id,n(void 0,o.messages)):o.error&&n(o.error)}function t(o){n(o)}fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({receive:r.lastId})}).then(function(o){o.json().then(e).catch(t)}).catch(t)}}}function getLongPollPosterMode(){return new Promise(function(n){function e(){t("error")}function t(o){n(o)}fetch("/msg-poll-mode.json",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then(function(o){o.json().then(t).catch(e)}).catch(e)})}function startTimerApi(){getLongPollPosterMode().then(function(o){if(console.log({useWs:o}),"error"===o)return location.replace(location.href);html.classList[o?"add":"remove"]("ws"),server_conn=openLongPollPoster(readNumber("lastLongPollId",0),function(o){processTimerApiMessage(o),writeNumber("lastLongPollId",server_conn.lastId)},o)})}window.timerAPI={send:sendTimerApiMessage};