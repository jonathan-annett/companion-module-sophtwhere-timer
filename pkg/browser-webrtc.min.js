let tabidInterval;window.tab_id="tab_"+Date.now().toString();var controller_tab_id="controller_"+tab_id;const updateTabTick=hysteresisWrap(doUpdateTabTick,500);var runMode="presenter";window.name="timer_webrtc";const invalidKeys=/^(tab_|controller_tab_)/,isValidKey=function(e){return!invalidKeys.test(e)};var timerWin,peer=new SimplePeer({initiator:!0,trickle:!1});const[button,button2,button3]=[].slice.call(document.querySelectorAll("button")),h1=document.querySelector("h1"),loopbackId=Math.random().toString();function waitStoragePeerData(e){"linked-peer-data"===e.key&&decodeObjectData(location.origin+"?"+e.newValue,location.origin,function(e,t){if(e)return alert(e);t&&t.signal&&t.id===loopbackId&&(window.onstorage=null,peer.signal(t.signal))})}function relayToPeer(e){var t;invalidKeys.test(e.key)||((t={storage:{}}).storage[e.key]=e.newValue,peer.send(JSON.stringify(t)),console.log({out:t}))}function openTimerWindow(e){return!0===e?(timerWin&&timerWin.close(),window.opener&&window.close(),timerWin=void 0):(timerWin=open("timer.html","timer_control_window"))&&timerWin.addEventListener("load",function(){console.log("timer win loaded"),timerWin.addEventListener("unload",onTimerWinUnload)}),!1}function onTimerWinUnload(){timerWin=void 0,button2.disabled=!1}function updateTabId(){getTabCount()}function doUpdateTabTick(e){writeNumber(tab_id,e),"controller"===runMode?writeNumber(controller_tab_id,e):localStorage.removeItem(controller_tab_id)}function hysteresisWrap(t,n){let o=null;return function(){var e=Date.now();o&&o+n>e||(o=e,t(e))}}function getTabCount(t){var n=[];let o=1,e=Date.now(),r=e-3e3;t||updateTabTick();for(let e=0;e<localStorage.length;e++){var i=localStorage.key(e);i!==tab_id&&i.startsWith("tab_")?Number(localStorage.getItem(i))<r?n.push(i):(!t||0<readNumber("controller_"+i,0))&&o++:i.startsWith("controller_tab_")&&Number(localStorage.getItem(i))<r&&n.push(i)}return n.forEach(function(e){localStorage.removeItem(e)}),o}function writeNumber(e,t){void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t.toString())}function readNumber(e,t){e=localStorage.getItem(e);return e?Number(e):t}localStorage.setItem("linked-peer-id",loopbackId),peer.on("signal",function(e){encodeObjectData({signal:e,id:loopbackId},location.origin+"/webrtcRemote.html?",function(e,t){if(e)return alert(e);document.querySelector("input").value=t,window.onstorage=waitStoragePeerData;const n=new Blob(["[InternetShortcut]\nURL="+t]);button.onclick=function(){saveAs(n,"linked.url"),button.onclick=null,button.disabled=!0},button2.onclick=function(){var e=document.querySelector("input");e.select(),e.setSelectionRange(0,99999),navigator.clipboard.writeText(e.value),button2.disabled=!0,button3.onclick=function(){navigator.clipboard.readText().then(function(e){var t=location.origin+"/webrtcSignal.html?";decodeObjectData(e,t,function(e,t){if(e)return alert(e);t&&t.signal&&t.id===loopbackId&&(window.onstorage=null,peer.signal(t.signal),button3.disabled=!0)})})},button3.disabled=!1},button.disabled=!1,button2.disabled=!1,h1.innerHTML="Open this link on the OTHER computer, and keep this tab open."})}),peer.on("connect",()=>{document.querySelector("input").hidden=!0,button.hidden=!0,h1.innerHTML="WebRTC Link Established",localStorage.removeItem("linked-peer-data"),localStorage.removeItem("linked-peer-id");const n={storage:{}};Object.keys(localStorage).filter(isValidKey).forEach(function(e){var t=localStorage.getItem(e);t&&(n.storage[e]=t)}),peer.send(JSON.stringify(n)),console.log({out:n}),window.onstorage=relayToPeer,button2.onclick=function(){openTimerWindow(!1),button2.disabled=!0,tabidInterval&&clearInterval(tabidInterval),tabidInterval=setInterval(updateTabId,500),setTimeout(function(){var e={ready:!0};peer.send(JSON.stringify(e)),console.log({out:e}),h1.innerHTML="Timer window opened - keep this tab open to maintain the WebRTC link"},1e3)},button2.innerHTML="open timer",button2.disabled=!1}),peer.on("close",function(){tabidInterval&&(clearInterval(tabidInterval),tabidInterval=void 0),location.replace(location.href)}),peer.on("error",function(){tabidInterval&&(clearInterval(tabidInterval),tabidInterval=void 0),location.replace(location.href)});