/*!
 * timer.js
 * Copyright(c) 2023 Jonathan Annett
 * MIT Licensed
 */
const oneSecond=1e3,oneMinute=60*oneSecond,skip_granularity=15*oneSecond;var timerWin;window.addEventListener("unload",onControlUnload);let server_conn,doc=document,qs=doc.querySelector.bind(doc),getEl=doc.getElementById.bind(doc),shifting=!1,controlling=!1,stylesheet1=getEl("style_1"),stylesheet1_obj;replaceStylesheet(stylesheet1,function(e){stylesheet1_obj=e});let aceScript,elapsedDisp=getEl("elapsed_disp"),remainDisp=getEl("remain_disp"),startedDisp=getEl("started_disp"),endsDisp=getEl("ends_disp"),remainInfoDisp=getEl("remain_info_message"),custom_message=getEl("custom_message"),durationDisp=getEl("duration_disp"),extraTimeDisp=getEl("extra_time_disp"),nowDisp=getEl("now_disp"),keyDisp=getEl("key_disp"),dispNextMins=getEl("disp_next_mins"),html=qs("html"),progress=qs(".progress"),pausedAt,pauseAcum=0,runMode="controller",togglePIPMode=setupPip("remain_disp","remain_disp_video",384,216,'100px "Lucida", sans-serif',"#remain_disp_video_text","overlay","#remain_disp_video_text",'40px "Lucida", sans-serif'),defaultDuration=(window.location.search.startsWith("?presenter")?(html.classList.add("reduced"),runMode="presenter",fs_api.isFullscreen()?document.title="Presentation Timer - Remote Screen (Fullscreen)":document.title="Presentation Timer - Remote Screen"):fs_api.isFullscreen()?document.title="Presentation Timer - Control Screen (Fullscreen)":document.title="Presentation Timer - Control Screen",readNumber("defaultDuration",10*oneMinute)),thisDuration=defaultDuration,startedAt=readNumber("startedAt",Date.now()),endsAt=readNumber("endsAt",startedAt+defaultDuration),seekEndsAt=readNumber("seekEndsAt",endsAt),lastUpdateTick=0,lastTimeText="",lastEndsAtText="",enterTimeText="",enterHoursText="",restartNeeded=(window.tab_id="tab_"+Date.now().toString(),custom_message.addEventListener("focus",function(){setTimeout(function(){document.execCommand("selectAll",!1,null)},2)}),progress.style.width="0%",dispNextMins.textContent=secToStr(defaultDuration/1e3),isNaN(startedAt)||isNaN(endsAt));if(!restartNeeded){let e=6e5;(Date.now()>endsAt+e||Date.now()>seekEndsAt+e)&&(restartNeeded=!0)}function keyMacroClick(t){if("mouse"!==t.pointerType||0===t.button){let e=this.dataset.keys.split(",").map(function(e){return e.startsWith("!")?{key:e.substr(1),__up:!0}:{key:e}});if(t.shiftKey&&" "===e[0].key){if(""!==enterTimeText)return this.dataset.keys=" ,"+enterTimeText.split("").join(",")+", ",this.innerHTML=enterTimeText,clearHtmlClass("editing"),dispNextMins.textContent=secToStr(defaultDuration/1e3),void(enterTimeText="");e=this.dataset.keys.split(",").map(function(e){return" "===e?{key:"Enter"}:{key:e}})}e.forEach(function(e){(e.__up?onDocKeyUp:onDocKeyDown)(e)})}}function openTimerWindow(e){return!0===e?(timerWin&&timerWin.close(),window.opener&&window.close(),timerWin=void 0):(timerWin=open("timer.html?presenter","remote_timer_window","location=0"))&&timerWin.addEventListener("load",function(){console.log("timer win loaded"),timerWin.addEventListener("unload",onTimerWinUnload)}),!1}function displayUpdate(){var t=getTabCount(),r=Date.now(),o=getTabCount(!0);let a=!1,i=!1,l=!1,c="0",d;if((1===t?clearHtmlClass:setHtmlClass)("twoplus"),fs_api.isFullscreen()?"presenter"===runMode?document.title="Presentation Timer - Remote Screen (Fullscreen)":"controller"===runMode?document.title="Presentation Timer - Control Screen (Fullscreen)":document.title="Presentation Timer (Fullscreen)":"presenter"===runMode?document.title=1===t?"Presentation Timer - Single Window":"Presentation Timer - Remote Screen":"controller"===runMode?document.title="Presentation Timer - Control Screen":document.title="Presentation Timer","controller"===runMode||1===t){var u=pausedAt?r-pausedAt:0;let e=(seekEndsAt-r)/oneSecond;0<e&&e++,d=secToStr(e),seekEndsAt<endsAt-500?(seekEndsAt,endsAt,skip_granularity,endsAt-=25,clearRemainClass("adjustingDown"),setRemainClass("adjusting"),c=Number((endsAt-seekEndsAt)/oneSecond).toFixed(1),keyDisp.textContent="speeding up to match actual time ("+d+")  "+c+" seconds offset",writeNumber("endsAt",endsAt),l=!0):seekEndsAt>endsAt+500?(seekEndsAt,endsAt,skip_granularity,endsAt+=25,clearRemainClass("adjusting"),setRemainClass("adjustingDown"),c=Number((endsAt-seekEndsAt)/oneSecond).toFixed(1),keyDisp.textContent="slowing down to match actual time ("+d+")  "+c+" seconds offset",writeNumber("endsAt",endsAt),i=!0):(endsAt=seekEndsAt,clearRemainClass("adjusting"),clearRemainClass("adjustingDown"),d=void 0,keyDisp.textContent=1===t?"":1<o?"MULTIPLE CONTROLLERS TABS ARE OPEN. CLOSE ONE!":0==u?"remote display active":"countdown was paused at "+local24HourTime(new Date(pausedAt)),writeNumber("endsAt",endsAt));var m,o=(endsAt-r+u)/oneSecond;let s,n;0!=u?(p=secToStr(u/oneSecond),remainInfoDisp.textContent="presenter"===runMode?"Paused":p,endsDisp.textContent=local24HourTime(new Date(seekEndsAt+u)),m=secToStr((pauseAcum+u)/oneSecond),extraTimeDisp.textContent="+ "+m+" pauses",a=!0,server_conn&&lastEndsAtText!==endsDisp.textContent&&(lastEndsAtText=endsDisp.textContent,server_conn.send(JSON.stringify({setVariableValues:{adjusting_up:l,adjusting_down:i,adjusting_delta:c,remain_actual:d,endsAt:lastEndsAtText,paused:p,pauses:m,pausing:a}})))):(remainInfoDisp.textContent="",0===pauseAcum?extraTimeDisp.textContent="":extraTimeDisp.textContent="+ "+secToStr(pauseAcum/oneSecond)+" pauses");var p=r-startedAt-(u+pauseAcum);if(p<0?(setHtmlClass("future"),(-6e4<p?setHtmlClass:clearHtmlClass)("impending"),seekEndsAt=startedAt+thisDuration,bumpEnd(0,0),endsAt=seekEndsAt,n=secToStr((0-p)/oneSecond),elapsedDisp.textContent=n,s=secToStr(thisDuration/1e3),localStorage.setItem("elapsedDisp",n)):(clearHtmlClass("future"),s=secToStr(0<=o?1+o:0-o),n=secToStr(p/oneSecond)),lastTimeText!==s&&(0===lastUpdateTick||750<r-lastUpdateTick)){lastUpdateTick=r,remainDisp.textContent=s,elapsedDisp.textContent=n,lastTimeText=s;let e=!1,t=!1;0<=o?(clearHtmlClass("over"),0<=p&&(o<=60?(setHtmlClass("impending"),t=!0):clearHtmlClass("impending")),setBar(p,thisDuration)):(e=!0,setHtmlClass("over"),clearHtmlClass("impending"),setBarPct(100)),localStorage.setItem("remainDisp",s),server_conn&&server_conn.send(JSON.stringify({setVariableValues:{adjusting_up:l,adjusting_down:i,adjusting_delta:c,remain_actual:d||s,expired:e,impending:t,pausing:a,remain:s,elapsed:n}}))}localStorage.setItem("remainDispClass",html.className)}else keyDisp.textContent=t+" tabs open";nowDisp.textContent=timeNowStr()}function updateEnteredTimeText(){""===enterHoursText?dispNextMins.textContent=secToStr(60*Number(enterTimeText)):dispNextMins.textContent=secToStr(3600*Number(enterHoursText)+60*Number(enterTimeText))}function replaceStylesheet(r,o){var a,e=r.href,s=new XMLHttpRequest;s.responseType="text",s.open("GET",e),s.onreadystatechange=function(){if(4==s.readyState){a=this.responseText;let e,s,n=document.createElement("style");n.innerHTML=a;var t=localStorage.getItem("custom_css");t&&(n.innerHTML=t),document.body.appendChild(n),r.parentNode.removeChild(r),o&&o(Object.defineProperties({},{sheet:{value:n},css:{set:function(e){n.innerHTML=e},get:function(){return n.innerHTML}},reset:{value:function(){n.innerHTML=a,localStorage.removeItem("custom_css")}},editToggle:{value:function(){if(e)n.innerHTML=e.getValue(),localStorage.setItem("custom_css",n.innerHTML),s.parentNode.removeChild(s),e=void 0;else{let t=function(){(s=document.createElement("pre")).id="css_editor",document.body.appendChild(s),setTimeout(function(){(e=ace.edit("css_editor")).setTheme("ace/theme/chrome"),e.session.setMode("ace/mode/css"),e.setValue(n.innerHTML),e.focus(),e.gotoLine(1)},10)};if(aceScript){let e=setInterval(function(){window.ace&&(clearInterval(e),t())},100)}else{(aceScript=document.createElement("script")).setAttribute("integrity","sha512-NSbvq6xPdfFIa2wwSh8vtsPL7AyYAYRAUWRDCqFH34kYIjQ4M7H2POiULf3CH11TRcq3Ww6FZDdLZ8msYhMxjg=="),aceScript.setAttribute("crossorigin","anonymous"),aceScript.setAttribute("referrerpolicy","no-referrer"),aceScript.setAttribute("src","https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.2/ace.js"),document.body.appendChild(aceScript);let e=setInterval(function(){window.ace&&(clearInterval(e),t())},100)}}}},editing:{get:function(){return!!e}}}))}},s.send()}function restartTimer(){lastUpdateTick=0,startedAt=Date.now(),endsAt=startedAt+defaultDuration,pausedAt=void 0,pauseAcum=0,thisDuration=defaultDuration,seekEndsAt=endsAt,startedDisp.textContent=local24HourTime(new Date(startedAt)),endsDisp.textContent=local24HourTime(new Date(endsAt)),durationDisp.textContent=secToStr(defaultDuration/1e3),extraTimeDisp.textContent="",writeNumber("pausedAt",pausedAt),writeNumber("pauseAcum",pauseAcum),writeNumber("startedAt",startedAt),writeNumber("endsAt",endsAt),writeNumber("seekEndsAt",seekEndsAt),clearHtmlClass("countup-override"),clearHtmlClass("paused"),setBarPct(0),server_conn&&server_conn.send(JSON.stringify({setVariableValues:{startedAt:startedDisp.textContent,endsAt:endsDisp.textContent,default:durationDisp.textContent,paused:"0:00",pauses:"0:00",pausing:!1,expired:!1,showpresenter:html.classList.contains("reduced")?"1":"0",impending:defaultDuration<=6e4}}))}function setPresenterMode(){runMode="presenter",html.classList.add("reduced"),server_conn&&server_conn.send(JSON.stringify({setVariableValues:{showpresenter:"1"}}))}function setControllerMode(){runMode="controller",html.classList.remove("reduced"),server_conn&&server_conn.send(JSON.stringify({setVariableValues:{showpresenter:"0"}}))}function extendDefaultToCurrentTimer(){lastUpdateTick=0,endsAt=startedAt+defaultDuration,thisDuration=defaultDuration,writeNumber("endsAt",seekEndsAt=endsAt),writeNumber("seekEndsAt",seekEndsAt),durationDisp.textContent=secToStr(defaultDuration/1e3),displayUpdate()}function onLocalStorage(e){var t;"presenter"!==runMode||"showbar"!==e.key&&!e.key.startsWith("remainDisp")||(remainDisp.textContent=localStorage.getItem("remainDisp"),html.className=localStorage.getItem("remainDispClass")+" reduced",1===readNumber("showbar",0)?(setHtmlClass("showbar"),setBarPct(Number(localStorage.getItem("barpct")))):clearHtmlClass("showbar")),"elapsedDisp"===e.key&&(elapsedDisp.textContent=localStorage.getItem("elapsedDisp")),"showtimenow"===e.key&&(1===readNumber("showtimenow",0)?setHtmlClass:clearHtmlClass)("showtimenow"),"showmessages"===e.key&&(1===readNumber("showmessages",0)?setHtmlClass:clearHtmlClass)("showmessages"),"custom_message"===e.key&&(t=localStorage.getItem("custom_message"),(""===(custom_message.textContent=t)?clearHtmlClass:setHtmlClass)("show_custom_message")),stylesheet1_obj&&!stylesheet1_obj.editing&&"custom_css"===e.key&&((t=localStorage.getItem("custom_css"))?stylesheet1_obj.css=t:stylesheet1_obj.reset())}function getTabCount(t){var s=[];let n=1,e=Date.now(),r=e-3e3;t||(writeNumber(tab_id,e),"controller"===runMode?writeNumber("controller_"+tab_id,e):localStorage.removeItem("controller_"+tab_id));for(let e=0;e<localStorage.length;e++){var o=localStorage.key(e);o!==tab_id&&o.startsWith("tab_")?Number(localStorage.getItem(o))<r?s.push(o):(!t||0<readNumber("controller_"+o,0))&&n++:o.startsWith("controller_tab_")&&Number(localStorage.getItem(o))<r&&s.push(o)}return s.forEach(function(e){localStorage.removeItem(e)}),n}restartNeeded?restartTimer():((Date.now()>endsAt||Date.now()>seekEndsAt)&&(endsAt=seekEndsAt,setHtmlClass("over")),startedDisp.textContent=local24HourTime(new Date(startedAt)),endsDisp.textContent=local24HourTime(new Date(endsAt)),durationDisp.textContent=secToStr((endsAt-startedAt)/1e3),pausedAt=readNumber("pausedAt",pausedAt),pauseAcum=readNumber("pauseAcum",pauseAcum),void 0!==pausedAt&&setHtmlClass("paused"),displayUpdate(),(1===readNumber("showbar",0)?setHtmlClass:clearHtmlClass)("showbar"),(1===readNumber("showtimenow",0)?setHtmlClass:clearHtmlClass)("showtimenow"),(1===readNumber("showmessages",0)?setHtmlClass:clearHtmlClass)("showmessages"),localStorage.setItem("remainDispClass",html.className)),dispNextMins.textContent=secToStr(defaultDuration/oneSecond),setInterval(displayUpdate,100),doc.addEventListener("keyup",onDocKeyUp),doc.addEventListener("keydown",onDocKeyDown),doc.addEventListener("contextmenu",function(e){e.preventDefault()}),addEventListener("storage",onLocalStorage),[].forEach.call(document.querySelectorAll("div.buttons div.btn"),function(e){e.addEventListener("pointerdown",keyMacroClick)});let custom_msg_timeout;function onDocKeyDown(e){if(html.classList.contains("edit_custom_message"))"Enter"===e.key&&(custom_message.contentEditable=!1,html.classList.remove("edit_custom_message"),"custom message"===custom_message.textContent?(html.classList.remove("show_custom_message"),localStorage.setItem("custom_message","")):(html.classList.add("show_custom_message"),custom_msg_timeout=setTimeout(function(){custom_msg_timeout=void 0,localStorage.setItem("custom_message",custom_message.textContent)},500)));else if(!html.classList.contains("show_custom_message")||"c"!==e.key&&"C"!==e.key)if(stylesheet1_obj&&stylesheet1_obj.editing)"S"!==e.key&&"s"!==e.key||!e.ctrlKey||(e.preventDefault(),stylesheet1_obj.editToggle(),e.shiftKey&&stylesheet1_obj.reset());else{var t=getTabCount(),s=Date.now(),n=controlling?6e4:1e3,r=controlling?6e4:0,o=controlling?6e4:1e3;if("string"==typeof e.key&&(1<=e.key&&e.key<=9||"0"===e.key))enterTimeText=enterTimeText+""+e.key,setHtmlClass("editing"),updateEnteredTimeText();else switch(e.key){case"/":case'"':html.classList.toggle("paused"),lastTimeText="",togglePIPMode&&(togglePIPMode.lastContent=""),html.classList.contains("paused")?(writeNumber("pausedAt",pausedAt=Date.now()),endsAt=seekEndsAt,a=secToStr(pauseAcum/oneSecond),extraTimeDisp.textContent="+ "+a+" pauses",server_conn&&server_conn.send(JSON.stringify({setVariableValues:{default:secToStr(defaultDuration/1e3),pausing:!0,pauses:a,paused:"0:00"}}))):(a=pausedAt?s-pausedAt:0,pausedAt=void 0,seekEndsAt+=a,pauseAcum+=a,writeNumber("pausedAt",pausedAt),writeNumber("pauseAcum",pauseAcum),a=secToStr(pauseAcum/oneSecond),extraTimeDisp.textContent="+ "+a+" pauses",endsAt=seekEndsAt,endsDisp.textContent=local24HourTime(new Date(seekEndsAt)),server_conn&&server_conn.send(JSON.stringify({setVariableValues:{default:secToStr(defaultDuration/1e3),endsAt:endsDisp.textContent,pausing:!1,pauses:a,paused:"0:00"}})));break;case"Tab":case"'":clearHtmlClass("paused"),pausedAt=void 0,pauseAcum=0,writeNumber("pausedAt",pausedAt),writeNumber("pauseAcum",pauseAcum),extraTimeDisp.textContent="",seekEndsAt=startedAt+thisDuration,endsAt=seekEndsAt,endsDisp.textContent=local24HourTime(new Date(seekEndsAt)),server_conn&&server_conn.send(JSON.stringify({setVariableValues:{endsAt:endsDisp.textContent,pauses:"0:00",paused:"0:00"}}));break;case".":""!==enterTimeText&&enterTimeText.indexOf(".")<0&&(enterTimeText+=e.key,setHtmlClass("editing"),updateEnteredTimeText());break;case":":""===enterHoursText&&(enterHoursText=enterTimeText,enterTimeText="",setHtmlClass("editing"),dispNextMins.textContent=secToStr(3600*Number(enterHoursText)+60*Number(enterTimeText)));break;case"Backspace":""!==enterTimeText?(enterTimeText=enterTimeText.substr(0,enterTimeText.length-1),updateEnteredTimeText()):(clearHtmlClass("editing"),dispNextMins.textContent=secToStr(defaultDuration/1e3));break;case"Enter":controlling?(lastUpdateTick=0,endsAt=seekEndsAt,clearRemainClass("adjusting"),clearRemainClass("adjustingDown"),keyDisp.textContent=t+" tabs open",writeNumber("endsAt",endsAt)):saveEditedTime();break;case"ArrowDown":html.classList.contains("editing")||(shifting?bumpStart(n):bumpEnd(0-o,0-r),durationDisp.textContent=secToStr((seekEndsAt-startedAt)/1e3),displayUpdate());break;case"q":case"Q":controlling&&is_nwjs()&&require("nw.gui").App.quit();break;case"ArrowUp":html.classList.contains("editing")||(shifting?bumpStart(0-n):bumpEnd(o,r),durationDisp.textContent=secToStr((seekEndsAt-startedAt)/1e3),displayUpdate());break;case"ArrowLeft":bumpStart(0-n),bumpEnd(0-o,0-r),durationDisp.textContent=secToStr((seekEndsAt-startedAt)/1e3),displayUpdate();break;case"ArrowRight":bumpStart(n),bumpEnd(o,r),durationDisp.textContent=secToStr((seekEndsAt-startedAt)/1e3),displayUpdate();break;case"Shift":shifting=!0,setHtmlClass("shifting");break;case"Control":controlling=!0,setHtmlClass("controlling");break;case"i":case"I":controlling&&shifting;break;case"F":case"f":fs_api.isFullscreen()?fs_api.exitFullscreen():fs_api.enterFullscreen();break;case"b":case"B":var a=html.classList.contains("showbar")?0:1;html.classList.toggle("showbar"),writeNumber("showbar",a);break;case"*":case" ":var a=defaultDuration;controlling?(lastUpdateTick=0,endsAt=seekEndsAt,clearRemainClass("adjusting"),clearRemainClass("adjustingDown"),keyDisp.textContent=t+" tabs open",lastTimeText="",writeNumber("endsAt",endsAt)):(saveEditedTime(),(shifting?extendDefaultToCurrentTimer:restartTimer)(),defaultDuration!==a&&(defaultDuration=a,dispNextMins.textContent=secToStr(defaultDuration/1e3),clearHtmlClass("editing"),writeNumber("defaultDuration",defaultDuration)));break;case"m":case"M":html.classList.toggle("showmessages"),writeNumber("showmessages",html.classList.contains("showmessages")?1:0),togglePIPMode&&(togglePIPMode.lastContent=""),lastTimeText="";break;case"t":case"T":a=html.classList.contains("showtimenow")?0:1;html.classList.toggle("showtimenow"),writeNumber("showtimenow",a);break;case"o":case"O":togglePIPMode&&togglePIPMode();break;case"p":case"P":"?presenter"!==window.location.search&&1===t&&(html.classList.toggle("reduced"),a=html.classList.contains("reduced"),runMode=a?"presenter":"controller",server_conn)&&server_conn.send(JSON.stringify({setVariableValues:{showpresenter:a?"1":"0"}})),html.classList[html.classList.contains("reduced")?"remove":"add"]("showbuttons");break;case"s":case"S":e.ctrlKey?(!stylesheet1_obj||e.shiftKey&&(stylesheet1_obj.reset(),!stylesheet1_obj.editing)||stylesheet1_obj.editToggle(),e.preventDefault()):"?presenter"!==window.location.search&&1===t&&(html.classList.add("reduced"),html.classList.add("showbuttons"),runMode="presenter",fs_api.isFullscreen()||fs_api.enterFullscreen(),server_conn)&&server_conn.send(JSON.stringify({setVariableValues:{showpresenter:"1"}}));break;case"x":case"X":extendDefaultToCurrentTimer();break;case"c":case"C":html.classList.add("edit_custom_message"),html.classList.remove("show_custom_message"),custom_message.innerText="custom message",custom_message.contentEditable=!0,custom_message.focus(),e.preventDefault();break;case"R":case"r":controlling||(e.preventDefault(),isSingleScreenMode())||"presenter"===runMode&&1===t||openTimerWindow(1<t)}}else html.classList.remove("edit_custom_message"),html.classList.remove("show_custom_message"),custom_msg_timeout&&(clearTimeout(custom_msg_timeout),custom_msg_timeout=void 0),localStorage.setItem("custom_message","")}function isSingleScreenMode(){return!window.location.search.startsWith("?presenter")&&html.classList.contains("reduced")&&html.classList.contains("showbuttons")&&"presenter"===runMode}function saveEditedTime(){""!==enterTimeText&&""!==enterTimeText&&(defaultDuration=1e3*(3600*Number(enterHoursText)+60*Number(enterTimeText)),Date.now()-startedAt<0&&(thisDuration=defaultDuration),enterTimeText="",enterHoursText="",dispNextMins.textContent=secToStr(defaultDuration/1e3),clearHtmlClass("editing"),writeNumber("defaultDuration",defaultDuration),server_conn)&&server_conn.send(JSON.stringify({setVariableValues:{default:dispNextMins.textContent}}))}function onDocKeyUp(e){switch(e.key){case"Shift":shifting=!1,clearHtmlClass("shifting");break;case"Control":controlling=!1,clearHtmlClass("controlling")}}function bumpStart(e){startedAt+=e,startedDisp.textContent=local24HourTime(new Date(startedAt)),writeNumber("startedAt",startedAt),lastTimeText="",server_conn&&server_conn.send(JSON.stringify({setVariableValues:{startedAt:startedDisp.textContent}}))}function bumpEnd(e,t){seekEndsAt+=e,endsAt+=t,thisDuration=seekEndsAt-startedAt,endsDisp.textContent=local24HourTime(new Date(seekEndsAt)),writeNumber("seekEndsAt",seekEndsAt),lastTimeText="",server_conn&&server_conn.send(JSON.stringify({setVariableValues:{endsAt:endsDisp.textContent}}))}function setBarPct(e){progress.style.width=e+"%",localStorage.setItem("barpct",e.toString())}function setBar(e,t){setBarPct(Math.floor(e/t*100))}function readNumber(e,t){e=localStorage.getItem(e);return e?Number(e):t}function writeNumber(e,t){var s;void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t.toString()),server_conn&&0<=["showtimenow","showmessages","showbar"].indexOf(e)&&((s={})[e]=t.toString()||"0",server_conn.send(JSON.stringify({setVariableValues:s})))}function secToStr(e){var t=e<0?"-":"",s=(e<0&&(e=0-e),Math.trunc(e/60)%60),n=Math.trunc(e/3600),e=Math.trunc(e%60),e=(e<10?"0":"")+e.toString();return n<1?t+s.toString()+":"+e:(s=(s<10?"0":"")+s.toString(),t+n.toString()+":"+s+":"+e)}function local24HourTime(e){e=e.toString().split(":");return e[0]=e[0].split(" ").pop(),e[2]=e[2].split(" ")[0],e.join(":")}function timeNowStr(){return local24HourTime(new Date)}function setRemainClass(e){remainDisp.classList.contains(e)||remainDisp.classList.add(e)}function clearRemainClass(e){remainDisp.classList.contains(e)&&remainDisp.classList.remove(e)}function toggleRemainClass(e){remainDisp.classList.toggle(e)}function setHtmlClass(e){html.classList.contains(e)||html.classList.add(e)}function clearHtmlClass(e){html.classList.contains(e)&&html.classList.remove(e)}function onTimerWinUnload(){localStorage.removeItem(timerWin.tab_id),timerWin=void 0}function onControlUnload(){timerWin&&(timerWin.close(),timerWin=void 0),localStorage.removeItem(tab_id),localStorage.removeItem("controller_"+tab_id)}function is_nwjs(){try{return void 0!==require("nw.gui")}catch(e){return!1}}function restartLongPoll(){getLongPollPosterMode().then(function(e){if(console.log({useWs:e}),"error"===e)return location.replace(location.href);html.classList[e?"add":"remove"]("ws"),server_conn=openLongPollPoster(readNumber("lastLongPollId",0),function(e){var{error:t,cmd:s,code:n}=e;processServerMessage(t,s,e,n),writeNumber("lastLongPollId",server_conn.lastId)},e)})}function getHexColor(e){if(getHexColor.cache){if(void 0!==getHexColor.cache[e])return getHexColor.cache[e]}else getHexColor.cache={};var t=document.createElement("div"),s=(t.style.color=e,window.getComputedStyle(document.body.appendChild(t)).color.match(/\d+/g).map(function(e){return parseInt(e,10)}));return document.body.removeChild(t),getHexColor.cache[e]=3<=s.length&&"#"+((1<<24)+(s[0]<<16)+(s[1]<<8)+s[2]).toString(16).substr(1),getHexColor.cache[e]}function getTimerColors(){if(server_conn){const o={setTimerColors:{}};let r=!1;(o.names||getCustomColorNames()).forEach(function(e){var t=getCustomColor(e),s=getHexColor(t),n=w3color(t).toName();t&&(o.setTimerColors[e]={color:t,hexColor:s,colorName:n},r=!0)}),r&&server_conn.send(JSON.stringify(o))}}function processServerMessage(e,t,s,n){switch(console.log(e,t,s,n),t){case"keys":s.keys.forEach(function(e){e.startsWith("~")?onDocKeyUp({key:e.substring(1),preventDefault:function(){}}):onDocKeyDown({key:e,preventDefault:function(){}})});break;case"adjust":s.addtime?bumpEnd(s.msecs,s.msecs):bumpEnd(0-s.msecs,0-s.msecs),durationDisp.textContent=secToStr((seekEndsAt-startedAt)/1e3),displayUpdate();break;case"nudge":s.addtime?bumpEnd(s.msecs,0):bumpEnd(0-s.msecs,0),durationDisp.textContent=secToStr((seekEndsAt-startedAt)/1e3),displayUpdate();break;case"customMessage":html.classList.remove("edit_custom_message"),html.classList.remove("show_custom_message"),custom_message.innerText=s.text.trim(),custom_message.contentEditable=!1,0<custom_message.innerText.length&&html.classList.add("show_custom_message"),localStorage.setItem("custom_message",custom_message.innerText);break;case"setTimerColor":setCustomColor(s.name,s.color);break;case"setTimerColors":setCustomColors(s.colors);break;case"getTimerColor":if(server_conn&&s.name){const s={setTimerColors:{}};var r=getCustomColor(s.name);r&&(s.setTimerColors[s.name]=r,server_conn.send(JSON.stringify(s)))}break;case"getTimerColors":getTimerColors();break;case"redirect":"number"==typeof s.url&&((r=new URL(location.href)).port=s.url.toString(),s.url=r.toString()),s.url&&(s.url.startsWith("/")||s.url.startsWith(location.origin.replace(/\:.*$/,"")))&&s.url!==location.href&&(s.delay?setTimeout(function(){location.replace(s.url)},s.delay):location.replace(s.url));break;case"presenter":"presenter"!==runMode&&location.replace("/?presenter");break;case"control":"presenter"===runMode&&location.replace("/");break;case"opened":server_conn&&(console.log("sending startup values",dispNextMins.textContent),r=pausedAt?Date.now()-pausedAt:0,server_conn.send(JSON.stringify({setVariableValues:{default:secToStr(defaultDuration/1e3),endsAt:endsDisp.textContent,startedAt:startedDisp.textContent,showtimenow:localStorage.getItem("showtimenow")||"0",showbar:localStorage.getItem("showbar")||"0",showmessages:localStorage.getItem("showmessages")||"0",paused:secToStr(r/1e3),pauses:secToStr((r+pauseAcum)/1e3)}})),lastTimeText="",togglePIPMode&&(togglePIPMode.lastContent=""),getTimerColors())}}function setupPip(e,t,s,n,r,o,a,i,l){const c=window.safari?function(){setTimeout(h,33)}:function(){requestAnimationFrame(h)},d=document.getElementById(t);if(!d.requestPictureInPicture)return null;const u=document.getElementById(e),m=o?document.querySelector(o):u,p=i?document.querySelector(i):null;getInheritedBackgroundColor(m);C.lastContent="";const g=document.createElement("canvas"),f=(g.width=s,g.height=n,d.style.position="absolute",d.style.bottom=0,d.style.right=0,d.style.opacity=0,g.getContext("2d"));f.font=r,f.textAlign="center",f.textBaseline="middle",h();t=g.captureStream();return d.srcObject=t,C.enterPIP=function(){return document.pictureInPictureElement?(html.classList.add(a),!1):document.pictureInPictureEnabled?(d.requestPictureInPicture(),html.classList.add(a),!0):void 0},C.exitPIP=function(){return document.pictureInPictureElement?(document.exitPictureInPicture(),html.classList.remove(a),!0):document.pictureInPictureEnabled?(html.classList.remove(a),!1):void 0},C;function h(){var e,t=u.textContent;C.lastContent!==t&&(f.fillStyle=getInheritedBackgroundColor(m),f.fillRect(0,0,g.width,g.height),f.fillStyle=getInheritedColor(m),f.font=r,f.fillText(t,g.width/2,g.height/2),p&&(f.font=l,"none"!==(e=window.getComputedStyle(p,":before").content))&&f.fillText(e.replace(/^\"|\"$/g,""),g.width/2,32,g.width),C.lastContent=t),c()}function C(){document.pictureInPictureElement?(document.exitPictureInPicture(),html.classList.remove(a)):document.pictureInPictureEnabled&&(d.requestPictureInPicture(),html.classList.add(a))}}function getInheritedBackgroundColor(e){var t=getDefaultBackground(),s=window.getComputedStyle(e).backgroundColor;return s!=t?s:e.parentElement?getInheritedBackgroundColor(e.parentElement):t}function getDefaultBackground(){var e=document.createElement("div"),t=(document.head.appendChild(e),window.getComputedStyle(e).backgroundColor);return document.head.removeChild(e),t}function getInheritedColor(e){var t=getDefaultColor(),s=window.getComputedStyle(e).color;return s!=t?s:e.parentElement?getInheritedColor(e.parentElement):t}function getDefaultColor(){var e=document.createElement("div"),t=(document.head.appendChild(e),window.getComputedStyle(e).color);return document.head.removeChild(e),t}function getCustomColor(e){return window.getComputedStyle(document.documentElement).getPropertyValue("--color-"+e)}function setCustomColor(e,t,s){var n=getCustomColor(e);return""===n?null:n!==t&&(document.documentElement.style.setProperty("--color-"+e,t),!1!==s&&server_conn&&((s={setTimerColors:{}}).setTimerColors[e]=t,server_conn.send(JSON.stringify(s))),n)}function getCustomColorNames(){return Array.from(document.styleSheets).filter(e=>null===e.href||e.href.startsWith(window.location.origin)).reduce((e,t)=>[...e,...Array.from(t.cssRules).reduce((e,t)=>":root"===t.selectorText?[...e,...Array.from(t.style).filter(e=>e.startsWith("--"))]:e,[])],[]).map(function(e){return e.replace(/^--color-/,"")})}function getCustomColors(e){const t={};return(e||getCustomColorNames()).forEach(function(e){t[e]=getCustomColor(e)}),t}function setCustomColors(n,e){const r={},o=!(!1===e||!server_conn)&&{setTimerColors:{}};let a=!1;return Object.keys(n).forEach(function(e){var t=n[e],s=setCustomColor(e,t,!1);s&&(r[e]=s,o)&&(o.setTimerColors[e]=t,a=!0)}),a&&server_conn.send(JSON.stringify(o)),r}"presenter"===runMode||"http:"!==location.protocol||location.hostname.endsWith(".com")||"function"!=typeof openLongPollPoster||restartLongPoll();