function setupStorageLink(t,e,n,o){let l=o,i=!1;n=n||[];let r,s,u=function(){};const a=(e=e||[/.*/g]).filter(v),c=e.filter(y),f=n.filter(v),d=n.filter(y);let g;return p(!0),Object.defineProperties({},{enabled:{get:function(){return g},set:p,enumerable:!0,configurable:!1},sendMessage:{value:function(t){m().then(function(e){var n="string"==typeof t?t:JSON.stringify(t,void 0,4);e.send(n)})},enumerable:!0,configurable:!1},onmessage:{get:function(){return u},set:function(e){"function"==typeof e&&(u=e)},enumerable:!0,configurable:!1},tabId:{get:function(){return l},set:function(e){l=e,m().then(function(e){e.send(b()),i=!0})},enumerable:!0,configurable:!1}});function b(){let n={allKeyValues:{}};var e=Object.keys(localStorage),t=(e.forEach(function(e){value=localStorage.getItem(e),n.allKeyValues[e]=value}),JSON.stringify(n,void 0,4));return e.forEach(function(e){delete n.allKeyValues[e]}),delete n.allKeyValues,delete n.tabId,t}function p(e){g&&!1===e?(window.removeEventListener("storage",h),g=!1,r&&r.then(function(e){e.onmessage=null,e.onerror=null,e.onclose=null,e.onopen=null,e.close(),r=null}),s&&(s.splice(0,s.length),s=void 0)):g||!1===e||(g=!0,m().then(function(e){window.addEventListener("storage",h),i||(e.send(b()),i=!0)}))}function y(e){return"string"==typeof e&&0<e.length}function v(e){return"object"==typeof e&&e.constructor===RegExp}function h(e){var n,t,{key:e,newValue:o,oldValue:l}=e;if(t=e,(0===a.length&&0===c.length||a.some(function(e){return e.test(t)})||0<=c.indexOf(t))&&(n=e,0===f.length&&0===d.length||!(f.some(function(e){return e.test(n)})||0<=d.indexOf(n)))){const i=JSON.stringify({key:e,newValue:o,oldValue:l},void 0,4);m().then(function(e){e.send(i)})}}function m(){return r||new Promise(w)}function w(e){if(s)s.push(e);else{s=[e];const n=new WebSocket(t);n.onopen=function(){const t=n.send.bind(n);n.send=function(e){var n=new Error("x").stack.split("\n");return console.log("ws.send:",e,"@",n[2]),t(e)},n.send(JSON.stringify({connect:1,storageId:l},void 0,4))},n.onclose=function(){n.onclose=null,n.onerror=null,n.onmessage=null,r=null,s&&(s.splice(0,s.length),s=void 0)},n.onmessage=function(e){if("string"==typeof e.data&&e.data.startsWith('{"'))try{JSON.parse(e.data).connected===l&&(n.onmessage=void 0,r=Promise.resolve(n),s.splice(0,s.length).forEach(function(e){e(n)}),s=void 0)}catch(e){}},n.onerror=function(e){}}}}let link;window.addEventListener("message",function(e){var{tabId:e,final:n,wsUrl:t,whitelist:o,blacklist:l}=e.data;typeof e+typeof n+typeof t+typeof o+typeof l=="stringbooleanstringobjectobject"&&(n&&link?link.tabId=e:link=setupStorageLink(t,o,l,e))});